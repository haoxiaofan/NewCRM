@using NewCRM.Dto.Dto
@model List<IGrouping<String, PowerDto>>
@{
    Layout = "~/Views/Shared/_LayoutApps.cshtml";

    var rolePowerResult = ViewData["RolePowerResult"] as RoleDto;

    if (rolePowerResult == null)
    {
        rolePowerResult = new RoleDto();
    }
}

<form action="detail.ajax.php" method="post" name="form" id="form">
    <input type="hidden" name="id" value="@Request["roleId"]">
    <div class="creatbox">
        <div class="middle">
            <p class="detile-title">
                <strong>编辑权限</strong>
            </p>
            <div class="input-label">
                <label class="label-text">权限名称：</label>
                <div class="label-box form-inline control-group">
                    @{
                        if (rolePowerResult.Name == null)
                        {
                            <text> <input type="text" name="val_name" value="" datatype="*" nullmsg="请输入权限名称"></text>
                        }
                        else
                        {
                            <text> <input type="text" name="val_name" value="@rolePowerResult.Name" datatype="*" nullmsg="请输入权限名称"></text>
                        }
                    }

                    <span class="help-inline"></span>
                </div>
            </div>
            <div class="input-label">
                <label class="label-text">专属权限：</label>
                <div class="label-box form-inline control-group">
                    <div class="permissions_apps">
                        @{
                            if (rolePowerResult.Powers.Any())
                            {
                                foreach (var powerDto in rolePowerResult.Powers)
                                {<text>
                            <div class="app" appid="@powerDto.Id">
                                <span class="del">删</span>
                            </div>
                                </text>
                                }
                            }
                        }
                    </div>
                    <a class="btn" href="javascript:;" menu="addapps">添加权限</a>
                    <input type="hidden" name="val_apps_id" id="val_apps_id" value="" datatype="*" nullmsg="请选择专属权限">
                    <span class="help-inline"></span>
                </div>
            </div>
            <div>
                <table class="list-table">
                    <thead>
                        <tr class="sep-row"><td colspan="100"></td></tr>
                        <tr class="col-name">
                            <th style="width:50%">权限标识</th>
                            <th style="width:50%">权限名称</th>
                        </tr>
                        <tr class="sep-row"><td colspan="100"></td></tr>
                    </thead>
                    <tbody class="list-con text-center">
                        @{
                            foreach (var groupingDto in Model)
                            {
                                var groupKey = groupingDto.Key;
                                <text>
                                    <tr class="list-bd">
                                        <td>@groupKey</td>
                                        <td>
                                            @{
                                                foreach (var powerDto in groupingDto)
                                                {
                                                    <text>
                                                        <div style="float: left">@powerDto.Name</div>
                                                    </text>
                                                }
                                            }
                                        </td>
                                    </tr>
                                </text>

                                                }
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="100">
                                @*<div class="pagination pagination-centered" id="pagination"></div>
                                    <input id="pagination_setting" type="hidden" per="15">*@
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    <div class="bottom-bar">
        <div class="con">
            <a class="btn btn-primary fr" id="btn-submit" href="javascript:;"><i class="icon-white icon-ok"></i> 确定</a>
            <a class="btn fr" href="javascript:window.parent.closeDetailIframe();" style="margin-right: 10px"><i class="icon-chevron-up"></i> 返回权限列表</a>
        </div>
    </div>
</form>
@section ChildrenScript
{
    <script>
        $(function () {
            $('#form').Validform({
                btnSubmit: '#btn-submit',
                postonce: false,
                showAllError: true,
                tiptype: function (msg, o) {
                    if (!o.obj.is('form')) {//验证表单元素时o.obj为该表单元素，全部验证通过提交表单时o.obj为该表单对象;
                        var B = o.obj.parents('.control-group');
                        var T = B.children('.help-inline');
                        if (o.type === 2) {
                            B.removeClass('error');
                            T.text('');
                        } else {
                            B.addClass('error');
                            T.text(msg);
                        }
                    }
                },
                ajaxPost: true,
                callback: function (data) {
                    if ($('input[name="id"]').val() !== '') {
                        if (data.status === 'y') {
                            $.dialog({
                                id: 'ajaxedit',
                                content: '修改成功，是否继续修改？',
                                okVal: '是',
                                ok: function () {
                                    $.dialog.list['ajaxedit'].close();
                                },
                                cancel: function () {
                                    window.parent.closeDetailIframe(function () {
                                        window.parent.$('#pagination').trigger('currentPage');
                                    });
                                }
                            });
                        }
                    } else {
                        if (data.status === 'y') {
                            $.dialog({
                                id: 'ajaxedit',
                                content: '添加成功，是否继续添加？',
                                okVal: '是',
                                ok: function () {
                                    location.reload();
                                    return false;
                                },
                                cancel: function () {
                                    window.parent.closeDetailIframe(function () {
                                        window.parent.$('#pagination').trigger('currentPage');
                                    });
                                }
                            });
                        }
                    }
                }
            });
            //添加应用
            $('a[menu=addapps]').click(function () {
                $.dialog.data('appsid', $('#val_apps_id').val());
                $.dialog.open('@Url.Action("AddPowerGotoRole", "Security")', {
                    id: 'alert_addapps',
                    title: '添加权限',
                    resize: false,
                    width: 360,
                    height: 300,
                    ok: function () {
                        $('#val_apps_id').val($.dialog.data('appsid')).focusout();
                        $.ajax({
                            type: 'POST',
                            url: 'detail.ajax.php',
                            data: 'ac=updateApps&appsid=' + $.dialog.data('appsid'),
                            success: function (msg) {
                                $('.permissions_apps').html(msg);
                            }
                        });
                    },
                    cancel: true
                });
            });
            //删除应用
            $('.permissions_apps').on('click', '.app .del', function () {
                var appid = $(this).parent().attr('appid');
                var appsid = $('#val_apps_id').val().split(',');
                var newappsid = [];
                for (var i = 0, j = 0; i < appsid.length; i++) {
                    if (appsid[i] !== appid) {
                        newappsid[j] = appsid[i];
                        j++;
                    }
                }
                $('#val_apps_id').val(newappsid.join(',')).focusout();
                $(this).parent().remove();
            });
        });
    </script>
}

